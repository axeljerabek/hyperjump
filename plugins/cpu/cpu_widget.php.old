<?php
function getCPULoad() {
    $cpuLoad = array();
    $cpuInfo = shell_exec("cat /proc/stat | grep '^cpu'");
    $lines = explode("\n", $cpuInfo);
    foreach ($lines as $line) {
        if (preg_match('/^cpu(\d+) (.+)/', $line, $matches)) {
            $core = $matches[1];
            $values = preg_split('/\s+/', $matches[2]);
            $total = array_sum($values);
            $idle = $values[3]; // Der vierte Wert ist die Idle-Zeit
            $load = 100 * (1 - ($idle / $total));
            $cpuLoad[$core] = round($load, 2);
        }
    }
    return $cpuLoad;
}

function getRAMUsage() {
    $free = shell_exec('free');
    $free = (string)trim($free);
    $free_arr = explode("\n", $free);
    $mem = preg_split('/\s+/', $free_arr[1]);
    $ram_total = floatval($mem[1]);
    $ram_used = floatval($mem[2]);
    $ram_usage = ($ram_used / $ram_total) * 100;
    return round($ram_usage, 2);
}

function getSwapUsage() {
    $free = shell_exec('free');
    $free = (string)trim($free);
    $free_arr = explode("\n", $free);
    $swap = preg_split('/\s+/', $free_arr[2]);
    $swap_total = floatval($swap[1]);
    $swap_used = floatval($swap[2]);
    $swap_usage = ($swap_used / $swap_total) * 100;
    return round($swap_usage, 2);
}
?>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Systemauslastung</title>
    <style>
        /* Füge hier deine CSS-Stile für Balken hinzu */
        .progress {
            width: 100%;
            height: 30px;
            background-color: #f0f0f0;
        }
        .bar {
            height: 100%;
            width: 0;
            transition: width 1s;
        }
        .green {
            background-color: #4CAF50;
        }
        .light-green {
            background-color: #6ACD63;
        }
        .light-orange {
            background-color: #FFA500;
        }
        .orange {
            background-color: #FF6600;
        }
        .red {
            background-color: #FF0000;
        }
    </style>
</head>
<body>
    <h1>Systemauslastung</h1>
    
    <div>CPU-Auslastung:</div>
    <?php
    $cpuLoadPerCore = getCPULoad();
    foreach ($cpuLoadPerCore as $core => $load) {
        echo "<div>Kern $core: $load%</div>";
        echo '<div class="progress">
            <div class="bar" id="cpuProgressBar' . $core . '"></div>
        </div>';
    }
    ?>

    <div>RAM-Auslastung: <?php echo getRAMUsage(); ?>%</div>
    <div class="progress">
        <div class="bar" id="ramProgressBar"></div>
    </div>

    <div>Swap-Auslastung: <?php echo getSwapUsage(); ?>%</div>
    <div class="progress">
        <div class="bar" id="swapProgressBar"></div>
    </div>

    <script>
        function updateProgressBars() {
            <?php
            $cpuLoadPerCore = getCPULoad();
            $ramUsage = getRAMUsage();
            $swapUsage = getSwapUsage();
            ?>
            <?php
            foreach ($cpuLoadPerCore as $core => $load) {
                echo 'updateProgressBar("cpuProgressBar' . $core . '", ' . $load . ');';
            }
            ?>
            updateProgressBar("ramProgressBar", <?php echo $ramUsage; ?>);
            updateProgressBar("swapProgressBar", <?php echo $swapUsage; ?>);

            // Aktualisiere alle 0.5 Sekunden
            setTimeout(updateProgressBars, 500);
        }

        function updateProgressBar(barId, value) {
            let progressBar = document.getElementById(barId);
            if (value <= 25) {
                progressBar.classList.add("green");
            } else if (value <= 50) {
                progressBar.classList.add("light-green");
            } else if (value <= 75) {
                progressBar.classList.add("light-orange");
            } else if (value <= 90) {
                progressBar.classList.add("orange");
            } else {
                progressBar.classList.add("red");
            }
            progressBar.style.width = value + "%";
        }

        // Starte die Aktualisierungsfunktion
        updateProgressBars();
    </script>
</body>
</html>
